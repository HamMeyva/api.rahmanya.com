# LiveStream enum definitions
enum LiveStreamMode {
    NORMAL
    PK_BATTLE
    MULTI_GUEST
}

enum ParticipantRole {
    HOST
    GUEST
    COHOST
    VIEWER
    guest
    host
    cohost
    viewer
}

type LiveStreamParticipant {
    id: ID!
    live_stream_id: ID!
    user_id: ID!
    role: ParticipantRole!
    participant_type: String
    isCoHost: Boolean
    zego_stream_id: String
    audio_enabled: Boolean
    video_enabled: Boolean
    joined_at: DateTime!
    left_at: DateTime
    is_active: Boolean!
    liveStream: AgoraChannel @belongsTo
    user: User @belongsTo
}

# Response Models
type AgoraChannel {
    id: ID!
    channel_name: String
    user_id: String!
    user: User @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraChannelResolver@resolveUser")
    is_online: Boolean
    language_id: String
    title: String!
    description: String
    thumbnail_url: String
    stream_key: String
    rtmp_url: String
    playback_url: String
    viewer_count: Int
    max_viewer_count: Int
    total_likes: Int
    total_gifts: Int
    total_coins_earned: Int
    tags: [String]
    category_id: ID
    category: LiveStreamCategory @belongsTo
    is_featured: Boolean
    settings: JSON
    status_id: Int
    status: String @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraChannelResolver@resolveStatus")
    started_at: DateTime
    ended_at: DateTime
    is_challenge_active: Boolean
    mode: LiveStreamMode!
    max_participants: Int!
    is_gifts_enabled: Boolean!
    # pkBattle: PKBattle @hasOne
    participants: [LiveStreamParticipant!]! @method(name: "participants")
    zego_room_id: String
    zego_app_id: String
    zego_server_secret: String
    is_cohost_stream: Boolean
    parent_channel_id: ID
    parent_channel: AgoraChannel @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraChannelResolver@resolveParentChannel")
    cohost_channel_ids: [ID]
    cohost_channels: [AgoraChannel!] @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraChannelResolver@resolveCohostChannels")
    shared_video_room_id: String
    mixed_stream_id: String
    mixer_task_id: String
    has_mixed_stream: Boolean
}

type CreateStreamResponse {
    success: Boolean!
    channelName: String
    token: String
    uid: Int
}

type StartStreamResponse {
    success: Boolean!
    message: String
    token: String
    channel_name: String
    stream_key: String
    agora_channel_id: ID
}

type EndStreamResponse {
    success: Boolean!
    message: String
}

type JoinStreamResponse {
    success: Boolean!
    message: String
    token: String
    channel_name: String
    agora_channel_id: ID
    is_cohost_stream: Boolean
    parent_channel_id: ID
    parent_channel_name: String
}

type LikeStreamResponse {
    success: Boolean!
    message: String
}

type StreamScreenShootResponse {
    success: Boolean!
    message: String
}

type LeaveStreamResponse {
    success: Boolean!
    message: String
}

type LiveStream {
    id: ID!
    title: String!
    description: String
    thumbnail_url: String
    status: String!
    is_online: Boolean!
    is_featured: Boolean!
    viewer_count: Int!
    max_viewer_count: Int!
    total_likes: Int!
    total_messages: Int!
    total_gifts: Int!
    total_coins_earned: Int!
    user: User @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@user")
    category: LiveStreamCategory @belongsTo
    recording_urls: [String]
    has_recording: Boolean
    started_at: DateTime
    is_challenge_active: Boolean
    mode: LiveStreamMode!
    max_participants: Int!
    is_gifts_enabled: Boolean!
    # pkBattle: PKBattle @hasOne
    participants: [LiveStreamParticipant!]! @method(name: "participants")
    ended_at: DateTime
    created_at: DateTime!
    updated_at: DateTime!
}

type LiveStreamViewer {
    id: ID!
    agora_channel_id: ID!
    user: User! @belongsTo
    status: String!
    gifts_sent: Int!
    coins_spent: Int!
    messages_count: Int!
    is_moderator: Boolean!
    is_blocked: Boolean!
    last_activity_at: DateTime!
    joined_at: DateTime!
    created_at: DateTime!
    updated_at: DateTime!
}

type LiveStreamMessage {
    id: ID!
    agora_channel_id: ID!
    user: User! @belongsTo
    message: String!
    is_pinned: Boolean!
    is_system_message: Boolean!
    is_deleted: Boolean!
    created_at: DateTime!
    updated_at: DateTime!
}

type LiveStreamCategory {
    id: ID!
    name: String!
    slug: String!
    description: String
    icon: String
    icon_url: String
    cover_image: String
    parent_id: ID
    is_active: Boolean!
    display_order: Int
    subcategories: [LiveStreamCategory!] @hasMany
    active_streams_count: Int
    created_at: DateTime!
    updated_at: DateTime!
}

type LiveStreamAnalytics {
    user_id: ID
    total_streams: Int!
    total_stream_duration: Int!
    total_viewers: Int!
    max_concurrent_viewers: Int!
    total_likes: Int!
    total_messages: Int!
    total_gifts: Int!
    total_coins_earned: Int!
    avg_viewer_duration: Float
    period: String
    start_date: DateTime
    end_date: DateTime
}

type StreamHeartbeatResponse {
    success: Boolean!
}

# Input Models
input StartStreamInput {
    title: String
    description: String
    language_id: ID
    category_id: ID
    thumbnail_url: String
    thumbnail_image: String
    thumbnail_extension: String
    agora_channel_id: String
    is_cohost: Boolean
    parent_stream_id: String
}

input ZegoRoomInviteInput {
    guestId: ID!
    roomId: String!
}

# Query
extend type Query {
    listLiveStreams(page: Int = 1, limit: Int = 20): [AgoraChannel!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@listLiveStreams")

    followingLiveStreams(page: Int = 1, limit: Int = 20): [AgoraChannel!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@followingLiveStreams")

    liveStreams(
        page: Int
        limit: Int
        search: String
        category_id: ID
        followed_only: Boolean
        featured_only: Boolean
    ): [LiveStream!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@liveStreams")

    liveStream(id: ID!): LiveStream
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@getLiveStream")

    userStreams(userId: ID!, page: Int, limit: Int): [LiveStream!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@userStreams")

    streamViewers(channel_id: ID!, limit: Int = 50): [LiveStreamViewer!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@streamViewers")

    streamViewerCount(streamId: ID!): Int!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@streamViewerCount")

    myViewerStatus(streamId: ID!): LiveStreamViewer
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@myViewerStatus")

    pinnedMessage(streamId: ID!): LiveStreamMessage
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@pinnedMessage")

    liveStreamCategories(
        parent_id: ID
        search: String
        page: Int
        limit: Int
    ): [LiveStreamCategory!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@liveStreamCategories")

    liveStreamCategory(id: ID!): LiveStreamCategory
        @find(model: "App\\Models\\LiveStreamCategory")
        @guard(with: ["sanctum"])

    categorySubcategories(
        categoryId: ID!
        page: Int
        limit: Int
    ): [LiveStreamCategory!]!
        @paginate(model: "App\\Models\\LiveStreamCategory")
        @guard(with: ["sanctum"])

    categoryStreams(categoryId: ID!, page: Int, limit: Int): [LiveStream!]!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@categoryStreams")

    userStreamStats(userId: ID): LiveStreamAnalytics!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@userStreamStats")

    streamAnalytics(streamId: ID!): LiveStreamAnalytics!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@streamAnalytics")

    performanceSummary(userId: ID, period: String): LiveStreamAnalytics!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@performanceSummary")
}

# Mutations
extend type Mutation {
    startStream(input: StartStreamInput!): StartStreamResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@startStream")

    streamHeartbeat(stream_id: ID!): StreamHeartbeatResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@streamHeartbeat")

    endStream(agora_channel_id: ID!): EndStreamResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@endStream")

    joinStream(agora_channel_id: ID!): JoinStreamResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@joinStream")

    leaveStream(agora_channel_id: ID!): LeaveStreamResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@leaveStream")

    likeStream(agora_channel_id: ID!): LikeStreamResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@likeStream")

    streamScreenShoot(agora_channel_id: ID!): StreamScreenShootResponse!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@streamScreenShoot")

    updateStream(
        streamId: ID!
        title: String
        description: String
        category_id: ID
        thumbnail_url: String
        settings: JSONObject
    ): LiveStream!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@updateStream")

    goLive(streamId: ID!): LiveStream!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@goLive")

    banViewer(streamId: ID!, viewerId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@banViewer")

    pinMessage(streamId: ID!, messageId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@pinMessage")

    unpinMessage(streamId: ID!, messageId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@unpinMessage")

    blockUserFromLiveStreamChat(streamId: ID!, userId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@blockUserFromLiveStreamChat")

    unblockUserFromLiveStreamChat(streamId: ID!, userId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@unblockUserFromLiveStreamChat")

    addModerator(streamId: ID!, userId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@addModerator")

    removeModerator(streamId: ID!, userId: ID!): Boolean!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@removeModerator")

    startRecording(channelName: String!, uid: String!): JSONObject!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@startRecording")

    endRecording(
        channelName: String!,
        resourceId: String!,
        sid: String!
    ): JSONObject!
        @guard(with: ["sanctum"])
        @field(resolver: "App\\GraphQL\\Resolvers\\Agora\\AgoraResolver@endRecording")
}
